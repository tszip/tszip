import e from"sade";import t from"tiny-glob/sync.js";import{watch as o,rollup as r}from"rollup";import n from"asyncro";import s from"chalk";import i from"jest";import{CLIEngine as a}from"eslint";import c from"path";import l from"execa";import p from"shelljs";import m from"ora";import u from"semver";import*as d from"fs-extra";import f from"fs-extra";import g from"camelcase";import"ansi-escapes";import{concatAllArray as h}from"jpjs";import{terser as y}from"rollup-plugin-terser";import{createConfigItem as x,DEFAULT_EXTENSIONS as w}from"@babel/core";import b from"@rollup/plugin-commonjs";import j from"@rollup/plugin-json";import v from"@rollup/plugin-replace";import E,{DEFAULTS as k}from"@rollup/plugin-node-resolve";import $ from"rollup-plugin-sourcemaps";import F from"rollup-plugin-typescript2";import S from"typescript";import{parse as D}from"@babel/parser";import C from"@babel/traverse";import{pascalCase as O}from"pascal-case";import{createBabelInputPluginFactory as J}from"@rollup/plugin-babel";import R from"lodash.merge";import{optimizeLodashImports as M}from"@optimize-lodash/rollup-plugin";import{existsSync as N,readFileSync as P}from"fs";import _ from"enquirer/lib/prompts/input.js";import I from"enquirer/lib/prompts/select.js";import T from"progress-estimator";import{stat as q}from"fs/promises";import"@babel/helper-module-imports";const B=console.error.bind(console);function z(e){const t=e.error||e,o=`${t.name?t.name+": ":""}${t.message||t}`,r=t.plugin?"rpt2"===t.plugin?`(typescript) ${o}`:`(${t.plugin} plugin) ${o}`:o;if(B(s.bold.red(r)),t.loc&&(B(),B(`at ${t.loc.file}:${t.loc.line}:${t.loc.column}`)),t.frame)B(),B(s.dim(t.frame));else if(e.stack){const e=t.stack.replace(r,"");B(s.dim(e))}B()}const A=e=>g((e=>e.replace(/^@.*\//,""))(e).toLowerCase().replace(/((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,"")),L=e=>e.toLowerCase().replace(/(^@.*\/)|((^[^a-zA-Z]+)|[^\w.-])|([^a-zA-Z0-9]+$)/g,""),U=f.realpathSync(process.cwd()),W=function(e){return c.resolve(U,e)},V={appPackageJson:W("package.json"),tsconfigJson:W("tsconfig.json"),testsSetup:W("test/setupTests.ts"),appRoot:W("."),appSrc:W("src"),appErrorsJson:W("errors/codes.json"),appErrors:W("errors"),appDist:W("dist"),appConfig:W("tsdx.config.js"),jestConfig:W("jest.config.js"),progressEstimatorCache:W("node_modules/.cache/.progress-estimator")};let Y;async function Z(){if(Y)return Y;try{await l("yarnpkg",["--version"]),Y="yarn"}catch(e){Y="npm"}return Y}const K=e=>s.bold(s.cyan(e)),X=async function(e){const t=await Z(),o={install:"npm"===t?"npm install":"yarn install",build:"npm"===t?"npm run build":"yarn build",start:"npm"===t?"npm run start":"yarn start",test:"npm"===t?"npm test":"yarn test"};return`\n  ${s.green("Awesome!")} You're now ready to start coding.\n  \n  I already ran ${K(o.install)} for you, so your next steps are:\n    ${K(`cd ${e}`)}\n  \n  To start developing (rebuilds on changes):\n    ${K(o.start)}\n  \n  To build for production:\n    ${K(o.build)}\n\n  To test your library with Jest:\n    ${K(o.test)}\n    \n  Questions? Feedback? Please let me know!\n  ${s.green("https://github.com/formium/tsdx/issues")}\n`};function G(e){const t={},o=Object.keys(e);for(const r of o)t[e[r]]=r;return t}function H(e){switch(e.type){case"StringLiteral":case"Literal":return e.value;case"BinaryExpression":if("+"!==e.operator)throw new Error("Unsupported binary operator "+e.operator);return H(e.left)+H(e.right);default:throw new Error("Unsupported type "+e.type)}}const Q={sourceType:"module",plugins:["classProperties","flow","jsx","trailingFunctionCommas","objectRestSpread"]};async function ee(e){if(!e||!e.errorMapFilePath)throw new Error("Missing options. Ensure you pass an object with `errorMapFilePath`.");if(!e.name||!e.name)throw new Error("Missing options. Ensure you pass --name flag to tsdx");const t=e.errorMapFilePath;let o;try{const e=await f.readFile(t,"utf-8");o=JSON.parse(e)}catch(e){o={}}const r=Object.keys(o);let n;function s(e){const t=D(e,Q);C(t,{CallExpression:{exit(e){var t;e.get("callee").isIdentifier({name:"invariant"})&&(t=H(e.node.arguments[1]),o.hasOwnProperty(t)||(o[t]=""+n++))}}})}return n=0===r.length?0:Math.max.apply(null,r)+1,o=G(o),async function(r){s(r),await async function(){const r=O(A(e.name));await f.ensureDir(V.appErrors),await f.writeFile(t,JSON.stringify(G(o),null,2)+"\n","utf-8"),await f.writeFile(V.appErrors+"/ErrorDev.js","\nfunction ErrorDev(message) {\n  const error = new Error(message);\n  error.name = 'Invariant Violation';\n  return error;\n}\n\nexport default ErrorDev;\n      ","utf-8"),await f.writeFile(V.appErrors+"/ErrorProd.js",`\nfunction ErrorProd(code) {\n  // TODO: replace this URL with yours\n  let url = 'https://reactjs.org/docs/error-decoder.html?invariant=' + code;\n  for (let i = 1; i < arguments.length; i++) {\n    url += '&args[]=' + encodeURIComponent(arguments[i]);\n  }\n  return new Error(\n    \`Minified ${r} error #\${code}; visit \${url} for the full message or \` +\n      'use the non-minified dev environment for full errors and additional ' +\n      'helpful warnings. '\n  );\n}\n\nexport default ErrorProd;\n`,"utf-8")}()}}const te=[{original:"lodash(?!/fp)",replacement:"lodash-es"}],oe=(e,...t)=>{const o=[];return t.forEach((t=>{t.forEach((t=>{const r=o.findIndex((e=>e.file.resolved===t.file.resolved));-1!==r?o[r]=x([o[r].file.resolved,R(o[r].options,t.options)],{type:e}):o.push(t)}))})),o},re=(e,t)=>t.map((({name:t,...o})=>x([require.resolve(t),o],{type:e}))),ne=J((()=>({options:({custom:e,...t})=>({customOptions:e,pluginOptions:t}),config(e,{customOptions:t}){const o=re("plugin",[{name:"babel-plugin-macros"},{name:"babel-plugin-annotate-pure-calls"},{name:"babel-plugin-dev-expression"},"cjs"!==t.format&&{name:"babel-plugin-transform-rename-import",replacements:te},{name:"babel-plugin-polyfill-regenerator",method:"usage-pure"},{name:"@babel/plugin-proposal-class-properties",loose:!0},(r=t.extractErrors,!!r&&(r.constructor!==Object||Object.keys(r).length>0)&&{name:"./errors/transformErrorMessages"})].filter(Boolean));var r;const n=e.options||{};n.presets=n.presets||[];const s=n.presets.findIndex((e=>e.file.request.includes("@babel/preset-env")));if(-1!==s){const e=n.presets[s];n.presets[s]=x([e.file.resolved,R({loose:!0,targets:t.targets},e.options,{modules:!1})],{type:"preset"})}else{const e=re("preset",[{name:"@babel/preset-env",targets:t.targets,modules:!1,loose:!0}]);n.presets=oe("preset",e,n.presets)}return n.plugins=oe("plugin",o,n.plugins||[]),n}}))),se=["react","react-native"],ie={errorMapFilePath:V.appErrorsJson};let ae={},ce={rollup:(e,t)=>e};async function le(e){const t=h(e.input.map((t=>function(e,t){return[e.format.includes("cjs")&&{...e,format:"cjs",env:"development",input:t},e.format.includes("cjs")&&{...e,format:"cjs",env:"production",input:t},e.format.includes("esm")&&{...e,format:"esm",input:t},e.format.includes("umd")&&{...e,format:"umd",env:"development",input:t},e.format.includes("umd")&&{...e,format:"umd",env:"production",input:t},e.format.includes("system")&&{...e,format:"system",env:"development",input:t},e.format.includes("system")&&{...e,format:"system",env:"production",input:t}].filter(Boolean)}(e,t).map(((e,t)=>({...e,writeMeta:0===t}))))));return await Promise.all(t.map((async(e,t)=>{const o=await async function(e,t){const o=await ee({...ie,...e}),r=e.format.includes("es")||e.format.includes("esm"),n=void 0!==e.minify?e.minify:"production"===e.env||r;let s=["esm","cjs"].includes(e.format)?"":e.format,i="esm"===e.format?"mjs":"cjs";const a=[`${V.appDist}/${L(e.name)}`,s,e.env,n?"min":"",i].filter(Boolean).join("."),l=S.readConfigFile(e.tsconfig||V.tsconfigJson,S.sys.readFile).config,p=S.parseJsonConfigFileContent(l,S.sys,"./").options,{PRODUCTION:m}=process.env;return{input:e.input,external:e=>!e.startsWith("regenerator-runtime")&&(!!se.includes(e)||(e=>!e.startsWith(".")&&!c.isAbsolute(e))(e)),shimMissingExports:!0,treeshake:{propertyReadSideEffects:!1},output:{file:a,format:r?"es":e.format,freeze:!1,esModule:Boolean(p?.esModuleInterop)||r,name:e.name||A(e.name),sourcemap:!0,globals:{react:"React","react-native":"ReactNative","lodash-es":"lodashEs","lodash/fp":"lodashFp"},exports:"named"},plugins:[!!e.extractErrors&&{name:"Extract errors",async transform(e){try{await o(e)}catch(e){return null}return{code:e,map:null}}},E({mainFields:["module","main","node"!==e.target?"browser":void 0].filter(Boolean),extensions:[...k.extensions,".cjs",".mjs",".jsx"]}),b({extensions:[".js",".cjs",".mjs"],esmExternals:!0,requireReturnsDefault:!0,transformMixedEsModules:!0,include:"umd"===e.format||r?/\/node_modules\//:/\/regenerator-runtime\//}),j(),{name:"Remove shebang",transform(t){let o=/^#!(.*)/,r=t.match(o);return ae[e.name]=r?"#!"+r[1]:"",{code:t=t.replace(o,""),map:null}}},F({typescript:S,tsconfig:e.tsconfig,tsconfigDefaults:{exclude:["**/*.spec.ts","**/*.test.ts","**/*.spec.tsx","**/*.test.tsx","node_modules","bower_components","jspm_packages",V.appDist],compilerOptions:{sourceMap:!0,declaration:!0,jsx:"react"}},tsconfigOverride:{compilerOptions:{module:"esnext",target:"esnext",...t>0?{declaration:!1,declarationMap:!1}:{}}},check:!e.transpileOnly&&0===t,useTsconfigDeclarationDir:Boolean(p?.declarationDir)}),e.legacy&&ne({exclude:"node_modules/**",extensions:[...w,"ts","tsx"],passPerPreset:!0,custom:{targets:{..."node"===e.target?{node:14}:{},esmodules:r},extractErrors:e.extractErrors,format:e.format},babelHelpers:"bundled"}),e.env&&v({preventAssignment:!0,"process.env.NODE_ENV":JSON.stringify(m?"production":"development")}),$(),n&&y({format:{keep_quoted_props:!0,comments:!1},compress:{keep_infinity:!0,pure_getters:!0,passes:10},ecma:e.legacy?5:2020,module:r,toplevel:"cjs"===e.format||r}),M({useLodashEs:r||void 0}),{name:"Add export default {}",renderChunk:async(e,t)=>t.exports.includes("default")||!r?null:{code:`${e}\nexport default {};`,map:null}}]}}(e,t);return ce.rollup(o,e)})))}N(V.appConfig)&&(ce=require(V.appConfig));const pe={name:"basic",dependencies:["husky","tsdx","tslib","typescript","size-limit","@size-limit/preset-small-lib"],packageJson:{version:"0.1.0",license:"MIT",main:"./dist/index.cjs",module:"./dist/index.mjs",exports:{"./package.json":"./package.json",".":{import:"./dist/index.mjs",require:"./dist/index.cjs"}},typings:"dist/index.d.ts",files:["dist","src"],engines:{node:">=14"},scripts:{start:"tsdx watch",build:"tsdx build",test:"tsdx test",posttest:"node test/import.mjs && node test/require.cjs",lint:"tsdx lint",prepare:"tsdx build",size:"size-limit",analyze:"size-limit --why"},peerDependencies:{},husky:{hooks:{"pre-commit":"tsdx lint"}},prettier:{printWidth:80,semi:!0,singleQuote:!0,trailingComma:"es5"}}},me={name:"react",dependencies:[...pe.dependencies,"@types/react","@types/react-dom","react","react-dom"],packageJson:{...pe.packageJson,peerDependencies:{react:">=16"},scripts:{...pe.packageJson.scripts,test:"tsdx test"}}},ue={basic:pe,react:me,"react-with-storybook":{dependencies:[...me.dependencies,"@babel/core","@storybook/addon-essentials","@storybook/addon-links","@storybook/addon-info","@storybook/addons","@storybook/react","react-is","babel-loader"],name:"react-with-storybook",packageJson:{...me.packageJson,scripts:{...me.packageJson.scripts,storybook:"start-storybook -p 6006","build-storybook":"build-storybook"}}}};async function de(){const e=V.appDist+"/src";await d.pathExists(e)&&(console.warn('[tsdx]: Your rootDir is currently set to "./". Please change your rootDir to "./src".\nTSDX has deprecated setting tsconfig.compilerOptions.rootDir to "./" as it caused buggy output for declarationMaps and more.\nYou may also need to change your include to remove "test", which also caused declarations to be unnecessarily created for test files.'),await d.copy(e,V.appDist,{overwrite:!0}),await d.remove(e))}const fe=e("tsdx");let ge;try{ge=JSON.parse(P(V.appPackageJson,"utf-8"))}catch(e){throw new Error(`Couldn't read app package.json: ${e}`)}const he=e=>q(e).then((e=>e.isDirectory())).catch((()=>!1)),ye=e=>q(e).then((e=>e.isFile())).catch((()=>!1));async function xe(e,o){return h([].concat(e&&e.length?e:o&&W(o)||await he(W("src"))&&await async function(e){const t=await ye(W("src/index.ts"))?".ts":await ye(W("src/index.tsx"))?".tsx":await ye(W("src/index.jsx"))?".jsx":".js";return W(`src/index${t}`)}()).map((e=>t(e))))}async function we(e){return{...e,name:e.name||ge.name,input:await xe(e.entry,ge.source),format:e.format.split(",").map((e=>"es"===e?"esm":e))}}async function be(){await d.remove(V.appDist)}function je(e){const t=L(e),o=`#!/usr/bin/env node\n'use strict';\n\nconst { NODE_ENV } = process.env;\nif (NODE_ENV === 'production')\n  module.exports = require('./${t}.production.min.cjs');\nelse\n  module.exports = require('./${t}.development.cjs');\n`;return d.outputFile(c.join(V.appDist,"index.cjs"),o)}function ve(e){const t=`#!/usr/bin/env node\n\nexport { default } from './${e}.min.mjs';\nexport * from './${e}.min.mjs';\n`;return d.outputFile(c.join(V.appDist,"index.mjs"),t)}function Ee(e){p.exec(`npm config set init-author-name "${e}"`,{silent:!0})}fe.command("create <pkg>").describe("Create a new package with TSDX").example("create mypackage").option("--template",`Specify a template. Allowed choices: [${Object.keys(ue).join(", ")}]`).example("create --template react mypackage").action((async(e,t)=>{console.log(s.blue("\n::::::::::: ::::::::  :::::::::  :::    :::\n    :+:    :+:    :+: :+:    :+: :+:    :+:\n    +:+    +:+        +:+    +:+  +:+  +:+\n    +#+    +#++:++#++ +#+    +:+   +#++:+\n    +#+           +#+ +#+    +#+  +#+  +#+\n    #+#    #+#    #+# #+#    #+# #+#    #+#\n    ###     ########  #########  ###    ###\n"));const o=m(`Creating ${s.bold.green(e)}...`);let r;try{const i=await d.realpath(process.cwd());let a=await async function t(r){if(!await d.pathExists(r))return r;o.fail(`Failed to create ${s.bold.red(e)}`);const n=new _({message:`A folder named ${s.bold.red(e)} already exists! ${s.bold("Choose a different name")}`,initial:e+"-1",result:e=>e.trim()});return e=await n.run(),r=await d.realpath(process.cwd())+"/"+e,o.start(`Creating ${s.bold.green(e)}...`),await t(r)}(i+"/"+e);const l=new I({message:"Choose a template",choices:Object.keys(ue)});t.template?(r=t.template.trim(),l.choices.includes(r)||(o.fail(`Invalid template ${s.bold.red(r)}`),r=await l.run())):r=await l.run(),o.start(),await d.copy(c.resolve(__dirname,`../templates/${r}`),a,{overwrite:!0}),await d.move(c.resolve(a,"./gitignore"),c.resolve(a,"./.gitignore"));let m=await d.readFile(c.resolve(a,"LICENSE"),{encoding:"utf-8"});m=m.replace(/<year>/,`${(new Date).getFullYear()}`);let f=function(){let e="";return e=p.exec("npm config get init-author-name",{silent:!0}).stdout.trim(),e||(e=p.exec("git config --global user.name",{silent:!0}).stdout.trim(),e?(Ee(e),e):(e=p.exec("npm config get init-author-email",{silent:!0}).stdout.trim(),e||(e=p.exec("git config --global user.email",{silent:!0}).stdout.trim(),e||e)))}();if(!f){o.stop();const e=new _({name:"author",message:"Who is the package author?"});f=await e.run(),Ee(f),o.start()}m=m.replace(/<author>/,f.trim()),await d.writeFile(c.resolve(a,"LICENSE"),m,{encoding:"utf-8"});const g=(e=>({name:t,author:o})=>({...e.packageJson,name:t,author:o,"size-limit":[{path:`dist/${t}.production.min.cjs`,limit:"10 KB"},{path:`dist/${t}.min.mjs`,limit:"10 KB"}]}))(ue[r]);process.chdir(a);const h=g({name:L(e),author:f}),y=function({engines:e}){return e&&e.node}(h);y&&!u.satisfies(process.version,y)&&(o.fail((n=y,`Unsupported Node version! Your current Node version (${s.red(process.version)}) does not satisfy the requirement of Node ${s.cyan(n)}.`)),process.exit(1)),await d.outputJSON(c.resolve(a,"package.json"),h),o.succeed(`Created ${s.bold.green(e)}`),await X(e)}catch(t){o.fail(`Failed to create ${s.bold.red(e)}`),z(t),process.exit(1)}var n;const i=ue[r],{dependencies:a}=i,f=m((g=a.sort(),`Installing npm modules:\n${g.map((function(e){return`    ${s.cyan(s.bold(e))}`})).join("\n")}\n`)).start();var g;try{const t=await Z();await l(t,function(e,t){switch(e){case"npm":return["install",...t,"--save-dev"];case"yarn":return["add",...t,"--dev"]}}(t,a)),f.succeed("Installed dependencies"),console.log(await X(e))}catch(e){f.fail("Failed to install dependencies"),z(e),process.exit(1)}})),fe.command("watch").describe("Rebuilds on any change").option("--entry, -i","Entry module").example("watch --entry src/foo.tsx").option("--target","Specify your target environment","browser").example("watch --target node").option("--name","Specify name exposed in UMD builds").example("watch --name Foo").option("--format","Specify module format(s)","cjs,esm").example("watch --format cjs,esm").option("--verbose","Keep outdated console output in watch mode instead of clearing the screen").example("watch --verbose").option("--noClean","Don't clean the dist folder").example("watch --noClean").option("--tsconfig","Specify custom tsconfig path").example("watch --tsconfig ./tsconfig.foo.json").option("--onFirstSuccess","Run a command on the first successful build").example('watch --onFirstSuccess "echo The first successful build!"').option("--onSuccess","Run a command on a successful build").example('watch --onSuccess "echo Successful build!"').option("--onFailure","Run a command on a failed build").example('watch --onFailure "The build failed!"').option("--transpileOnly","Skip type checking").example("watch --transpileOnly").option("--extractErrors","Extract invariant errors to ./errors/codes.json.").example("watch --extractErrors").action((async e=>{const t=await we(e),r=await le(t);t.noClean||await be(),t.format.includes("cjs")&&await je(t.name),t.format.includes("esm")&&await ve(t.name);let n=!0,i=null,a=null;function c(e){if(!e)return null;const[t,...o]=e.split(" ");return l(t,o,{stdio:"inherit"})}const p=m().start();o(r.map((e=>({watch:{silent:!0,include:["src/**"],exclude:["node_modules/**"]},...e})))).on("event",(async e=>{if(await Promise.all([i?i.kill("SIGTERM"):null,a?a.kill("SIGTERM"):null]),"START"===e.code&&(t.verbose||process.stdout.write("win32"===process.platform?"[2J[0f":"[2J[3J[H"),p.start(s.bold.cyan("Compiling modules..."))),"ERROR"===e.code&&(p.fail(s.bold.red("Failed to compile")),z(e.error),a=c(t.onFailure)),"END"===e.code){p.succeed(s.bold.green("Compiled successfully")),console.log(`\n  ${s.dim("Watching for changes")}\n`);try{await de(),n&&t.onFirstSuccess?(n=!1,c(t.onFirstSuccess)):i=c(t.onSuccess)}catch(e){}}}))})),fe.command("build").describe("Build your project once and exit").option("--entry, -i","Entry module").example("build --entry src/foo.tsx").option("--target","Specify your target environment","browser").example("build --target node").option("--name","Specify name exposed in UMD builds").example("build --name Foo").option("--format","Specify module format(s)","cjs,esm").example("build --format cjs,esm").option("--legacy","Babel transpile and emit ES5.").example("build --legacy").option("--tsconfig","Specify custom tsconfig path").example("build --tsconfig ./tsconfig.foo.json").option("--transpileOnly","Skip type checking").example("build --transpileOnly").option("--extractErrors","Extract errors to ./errors/codes.json and provide a url for decoding.").example("build --extractErrors=https://reactjs.org/docs/error-decoder.html?invariant=").action((async e=>{const t=await we(e),o=await le(t);await be();const s=await async function(){return await f.ensureDir(V.progressEstimatorCache),T({storagePath:V.progressEstimatorCache})}();t.format.includes("cjs")&&s(je(t.name).catch(z),"Creating CJS entry file"),t.format.includes("esm")&&s(ve(t.name).catch(z),"Creating MJS entry file");try{const e=n.map(o,(async e=>{let t=await r(e);await t.write(e.output)})).catch((e=>{throw e})).then((async()=>{await de()}));s(e,"Building modules"),await e}catch(e){z(e),process.exit(1)}})),fe.command("test").describe("Run jest test runner. Passes through all flags directly to Jest").action((async e=>{process.env.BABEL_ENV="test",process.env.NODE_ENV="test",process.on("unhandledRejection",(e=>{throw e}));const t=process.argv.slice(2);let o={...(r=e.config?c.dirname(e.config):V.appRoot,{transform:{".(ts|tsx)$":require.resolve("ts-jest/dist"),".(js|jsx)$":require.resolve("babel-jest")},transformIgnorePatterns:["[/\\\\]node_modules[/\\\\].+\\.(js|jsx)$"],moduleFileExtensions:["ts","tsx","js","jsx","json","node"],collectCoverageFrom:["src/**/*.{ts,tsx,js,jsx}"],testMatch:["<rootDir>/**/*.(spec|test).{ts,tsx,js,jsx}"],testURL:"http://localhost",rootDir:r,watchPlugins:[require.resolve("jest-watch-typeahead/filename"),require.resolve("jest-watch-typeahead/testname")]}),...ge.jest};var r;const n=await d.pathExists(V.jestConfig);if(e.config||n){const t=W(e.config||V.jestConfig),r=require(t);o={...o,...r}}if(e.config){let e=t.indexOf("--config");if(-1!==e)t.splice(e,2);else{const o=/--config=.+/;e=t.findIndex((e=>e.match(o))),-1!==e&&t.splice(e,1)}}t.push("--config",JSON.stringify({...o}));const[,...s]=t;i.run(s)})),fe.command("lint").describe("Run eslint with Prettier").example("lint src test").option("--fix","Fixes fixable errors and warnings").example("lint src test --fix").option("--ignore-pattern","Ignore a pattern").example("lint src test --ignore-pattern test/foobar.ts").option("--max-warnings","Exits with non-zero error code if number of warnings exceed this number",Infinity).example("lint src test --max-warnings 10").option("--write-file","Write the config file locally").example("lint --write-file").option("--report-file","Write JSON report to file locally").example("lint --report-file eslint-report.json").action((async e=>{if(0===e._.length&&!e["write-file"]){const t=["src","test"].filter(d.existsSync);e._=t,console.log(s.yellow(`Defaulting to "tsdx lint ${t.join(" ")}"`,'\nYou can override this in the package.json scripts, like "lint": "tsdx lint src otherDir"'))}const t=await async function({pkg:e,rootDir:t,writeFile:o}){const r={extends:["react-app","prettier/@typescript-eslint","plugin:prettier/recommended"],settings:{react:{version:Boolean(function({dependencies:e,devDependencies:t}){return e&&e.react||t&&t.react}(e))?"detect":"999.999.999"}}};if(!o)return r;const n=c.join(t,".eslintrc.js");try{await f.writeFile(n,`module.exports = ${JSON.stringify(r,null,2)}`,{flag:"wx"})}catch(e){return"EEXIST"===e.code?console.error("Error trying to save the Eslint configuration file:",`${n} already exists.`):console.error(e),r}}({pkg:ge,rootDir:V.appRoot,writeFile:e["write-file"]}),o=new a({baseConfig:{...t,...ge.eslint},extensions:[".ts",".tsx",".js",".jsx"],fix:e.fix,ignorePattern:e["ignore-pattern"]}),r=o.executeOnFiles(e._);e.fix&&a.outputFixes(r),console.log(o.getFormatter()(r.results)),e["report-file"]&&await d.outputFile(e["report-file"],o.getFormatter("json")(r.results)),r.errorCount&&process.exit(1),r.warningCount>e["max-warnings"]&&process.exit(1)})),fe.parse(process.argv);export{he as isDir,ye as isFile};
export default {};
//# sourceMappingURL=tsdx.min.mjs.map
